<!-- @format -->

<script>
  import {onMount, getContext} from 'svelte'
  import QR from 'svelte-kjua'
  import {fetchTemplateData} from './helpers'
  import {shopKeys} from './shopStore'
  const notifier = getContext('notifier')

  export var params = {}
  var template = {
    id: params.templateId,
    shop: params.shopId,
    path_params: [],
    query_params: [],
    currency: ''
  }

  var lnurlparams = {}
  var lnurl
  function clearLNURL() {
    lnurl = null
  }
  async function generateLNURL(e) {
    e.preventDefault()
    try {
      var qs = new URLSearchParams()
      for (let k in lnurlparams) {
        qs.set(k, lnurlparams[k])
      }

      let r = await window.fetch(
        `/shop/${template.shop}/template/${template.id}/lnurl?${qs.toString()}`,
        {
          method: 'GET',
          headers: {
            Authorization: 'Basic ' + shopKeys.getShopToken(template.shop)
          }
        }
      )
      let res = await r.json()
      if (res.error) {
        throw new Error(res.error)
      }
      lnurl = res
    } catch (err) {
      notifier.warning(`Couldn't generate lnurl: ${err.message}`, 10000)
    }
  }

  onMount(async () => {
    try {
      template = await fetchTemplateData(params.shopId, params.templateId)
    } catch (err) {
      notifier.warning(`Couldn't fetch template data: ${err.message}`, 10000)
    }
  })
</script>

<div>
  <h1><a href="#/shop/{template.shop}">{template.shop}</a> / {template.id}</h1>
  <table>
    <tr>
      <th>Params:</th>
      <td>
        {template.path_params.join('/')} ? {template.query_params.join('&')}
      </td>
    </tr>
    <tr>
      <th>Description:</th>
      <div>{template.description}</div>
    </tr>
    {#if template.image}
    <tr>
      <th>Image:</th>
      <img alt="product image" src="{template.image}" />
    </tr>
    {/if}
    <tr>
      <th>Currency:</th>
      <td>{template.currency.toUpperCase()}</td>
    </tr>
    <tr>
      <th>Price:</th>
      <td>
        {template.min_price}{#if template.min_price != template.max_price}--
        {template.max_price}{/if}
      </td>
    </tr>
  </table>

  <a class="button" href="#/shop/{template.shop}/template/{template.id}/edit">
    Edit
  </a>
</div>

{#if params.templateId }
<div>
  <h2>Generate lnurl</h2>
  <form on:submit="{generateLNURL}">
    {#each template.path_params as p (p)}
    <label>
      {p}: <input bind:value="{lnurlparams[p]}" on:input="{clearLNURL}" />
    </label>
    {/each} {#each template.query_params as p (p)}
    <label>
      {p}: <input bind:value="{lnurlparams[p]}" on:input="{clearLNURL}" />
    </label>
    {/each}
    <button>Generate</button>
  </form>
  {#if lnurl}
  <div>
    <QR value="{lnurl}" color="white" />
    <pre><code>{lnurl}</code></pre>
  </div>
  {/if}
</div>
{/if}

<style></style>
