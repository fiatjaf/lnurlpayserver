<!-- @format -->

<script>
  import {getContext} from 'svelte'
  const notifier = getContext('notifier')

  const certPlaceholder = `-----BEGIN CERTIFICATE-----
  MIICPDCCAeKgAwIBAgIRAMzWW6TGNgkeFEW4QfJY0U0wCgYIKoZI
  MB0GA1UEChMWbG5kIGF1dG9nZW5lcmF0ZWQgY2VydDEUMBIGA1UE
  YXdlcmswHhcNMTkxMTIxMTkyOTU3WhcNMjEwMTE1MTkyOTU3WjA3
  ExZsbmQgYXV0b2dlbmVyYXRlZCBjZXJ0MRQwEgYDVQQDEwtib2ht
  MBMGByqGSM49AgEGCCqGSM49AwEHA0IABMtmmd3yz4f+pY4qKVl8
  NAzrdotd+ZbM5mu7h5OMVMPtJ9LBnl0ovCBF15qBlWlpoO/bgGRh
  DgYDVR0PAQH/BAQDAgKkMA8GA1UdEwEB/wQFMAMBAf8wgacGA1Ud
  Ym9obS1iYXdlcmuCCWxvY2FsaG9zdIIEdW5peIIKdW5peHBhY2tl
  AAAAAAAAAAAAAAAAAAAAAYcEwKgPB4cECpMRE4cEwKg4AYcQKAQH
  /oXS3IcQ/oAAAAAAAADqQPL//oXS3IcQ/oAAAAAAAAA0AlH//mk9
  AAAIACf//gAAADAKBggqhkjOPQQDAgNIADBFAiA/64u25xBr+/CQ
  URFBB1y4AyysJe24lwIhAKyTkeIHCW1DwTGxQH9tfTlHfL1USABD
  -----END CERTIFICATE-----`

  var kind = 'lnd'
  var data = {}
  var showTLSCert = false
  var successId

  async function setLightningServer(e) {
    e.preventDefault()

    try {
      let res = await window.fetch(`/set/${kind}`, {
        method: 'PUT',
        body: JSON.stringify(data)
      })
      let {id, ok, error} = await res.json()
      if (!ok) {
        throw new Error(error)
      } else {
        notifier.success(`Settings saved!`)
        successId = id
      }
    } catch (err) {
      notifier.warning(`Couldn't save: ${err.message}`, 10000)
      return
    }
  }
</script>

<section>
  <form on:submit="{setLightningServer}">
    {#if successId}
    <h1>Node {successId} connected!</h1>
    <p>
      Visit <a href="/{successId}">your donation page to get your static QR</a>
    </p>
    {:else}
    <select bind:value="{kind}">
      <option>sparko</option>
      <option>lnd</option>
    </select>
    {#if kind == 'sparko'}
    <label
      >endpoint:
      <input
        bind:value="{data.endpoint}"
        placeholder="https://my.sparko:9737/rpc"
    /></label>
    <label>key: <input bind:value="{data.key}"/></label>
    {:else if kind == 'lnd'}
    <label
      >HTTP endpoint:
      <input bind:value="{data.endpoint}" placeholder="https://my.lnd:8080"
    /></label>
    <label
      >invoice macaroon: <textarea rows="5" bind:value="{data.macaroon}" /> as
      hex</label
    >
    {/if} {#if showTLSCert}
    <label
      >tls certificate:
      <textarea
        rows="16"
        bind:value="{data.cert}"
        placeholder="{certPlaceholder}"
    /></label>
    {:else}
    <a on:click="{e => showTLSCert = true}"
      >include tls cert? (click if you know what you're doing.)</a
    >
    {/if}
    <button>save</button>
    {/if}
  </form>
</section>

<style>
  section {
    width: 100%;
    display: flex;
    flex-wrap: wrap;
  }
  form {
    width: 58%;
    margin-right: 2%;
    min-width: 400px;
  }
  form * {
    margin: 2px 4px;
  }
  section > div {
    width: 40%;
    min-width: 300px;
  }
  label {
    display: flex;
    align-items: center;
  }
  input,
  textarea {
    flex-grow: 2;
  }
  button {
    display: block;
    width: 50%;
    padding: 4px;
    margin: 4px auto !important;
  }
  h1 {
    white-space: pre-wrap;
    word-wrap: break-word;
    word-break: break-all;
  }
  a {
    cursor: pointer;
    color: #4a680d;
    text-decoration: underline;
  }
</style>
