<!-- @format -->

<script>
  import {getContext} from 'svelte'
  import {shopKeys} from './shopStore'
  const notifier = getContext('notifier')

  const certPlaceholder = `-----BEGIN CERTIFICATE-----
  MIICPDCCAeKgAwIBAgIRAMzWW6TGNgkeFEW4QfJY0U0wCgYIKoZI
  MB0GA1UEChMWbG5kIGF1dG9nZW5lcmF0ZWQgY2VydDEUMBIGA1UE
  YXdlcmswHhcNMTkxMTIxMTkyOTU3WhcNMjEwMTE1MTkyOTU3WjA3
  ExZsbmQgYXV0b2dlbmVyYXRlZCBjZXJ0MRQwEgYDVQQDEwtib2ht
  MBMGByqGSM49AgEGCCqGSM49AwEHA0IABMtmmd3yz4f+pY4qKVl8
  NAzrdotd+ZbM5mu7h5OMVMPtJ9LBnl0ovCBF15qBlWlpoO/bgGRh
  DgYDVR0PAQH/BAQDAgKkMA8GA1UdEwEB/wQFMAMBAf8wgacGA1Ud
  Ym9obS1iYXdlcmuCCWxvY2FsaG9zdIIEdW5peIIKdW5peHBhY2tl
  AAAAAAAAAAAAAAAAAAAAAYcEwKgPB4cECpMRE4cEwKg4AYcQKAQH
  /oXS3IcQ/oAAAAAAAADqQPL//oXS3IcQ/oAAAAAAAAA0AlH//mk9
  AAAIACf//gAAADAKBggqhkjOPQQDAgNIADBFAiA/64u25xBr+/CQ
  URFBB1y4AyysJe24lwIhAKyTkeIHCW1DwTGxQH9tfTlHfL1USABD
  -----END CERTIFICATE-----`

  var showTLSCert = false
  var backend = {kind: 'lnd', connection: {}}
  var shop = {
    id: '',
    key: parseInt(Math.random() * 1000000).toString(),
    message: '',
    verification: {kind: 'none'},
    webhook: null,
    telegram: null
  }

  function cleanupBackend() {
    let {endpoint, cert} = backend.connection
    backend.connection = {endpoint, cert}
  }

  function cleanupVerification() {
    let kind = shop.verification.kind
    shop.verification = {kind}
  }

  async function save(e) {
    e.preventDefault()

    if (shop.verification.words && shop.verification.words.length) {
      shop.verification.words = shop.verification.words
        .split(' ')
        .map(x => x.trim())
        .filter(x => x)
    }

    try {
      let r = await window.fetch(`/${shop.id}`, {
        method: 'PUT',
        body: JSON.stringify({...backend, ...shop})
      })
      let key = await r.json()
      if (key.error) {
        throw new Error(key.error)
      } else {
        notifier.success(`Shop ${shop.id} created with key ${key}!`)
        shopKeys.addShop(shop.id, key)
      }
    } catch (err) {
      notifier.warning(`Couldn't save: ${err.message}`, 10000)
    }
  }
</script>

<h1>Creating shop</h1>
<form on:submit="{save}">
  <h2>Shop details</h2>
  <label>shop id: <input bind:value="{shop.id}" placeholder="myshop"/></label>
  verification code to show after buy:
  <select
    bind:value="{shop.verification.kind}"
    on:change="{cleanupVerification}"
  >
    <option>none</option>
    <option>sequential</option>
    <option>hmac</option>
  </select>
  {#if shop.verification.kind == 'sequential'}
  <label>
    iterate over this sequence of words:
    <input
      bind:value="{shop.verification.words}"
      placeholder="word1 word2 word3 etc."
    />
  </label>
  <label>
    start at:
    <input
      bind:value="{shop.verification.init}"
      placeholder="10"
      type="number"
    />
  </label>
  {:else if shop.verification.kind == 'hmac'}
  <label>
    key:
    <input bind:value="{shop.verification.key}" placeholder="HMAC Key" />
  </label>
  <label>
    interval (in minutes):
    <input
      bind:value="{shop.verification.interval}"
      placeholder="10"
      type="number"
    />
  </label>
  {/if}
  <label>
    message:
    <input bind:value="{shop.message}" placeholder="thank you for buying" />
  </label>
  <h2>Lightning backend</h2>
  <select bind:value="{backend.kind}" on:change="{cleanupBackend}">
    <option>spark</option>
    <option>lnd</option>
  </select>
  {#if backend.kind == 'spark'}
  <label>
    endpoint:
    <input
      bind:value="{backend.connection.endpoint}"
      placeholder="https://my.sparko:9737/rpc"
    />
  </label>
  <label>key: <input bind:value="{backend.connection.key}"/></label>
  {:else if backend.kind == 'lnd'}
  <label>
    HTTP endpoint:
    <input
      bind:value="{backend.connection.endpoint}"
      placeholder="https://my.lnd:8080"
    />
  </label>
  <label>
    invoice macaroon:
    <textarea rows="5" bind:value="{backend.connection.macaroon}" /> as hex
  </label>
  {/if} {#if showTLSCert}
  <label
    >tls certificate:
    <textarea
      rows="16"
      bind:value="{backend.connection.cert}"
      placeholder="{certPlaceholder}"
    />
  </label>
  {:else}
  <a on:click="{e => showTLSCert = true}">
    include tls cert? (click if you know what you're doing)</a
  >
  {/if}
  <button>Save</button>
</form>

<style>
  form * {
    margin: 2px 4px;
  }
  label {
    display: flex;
    align-items: center;
  }
  input,
  textarea {
    flex-grow: 2;
  }
  button {
    display: block;
    width: 50%;
    padding: 4px;
    margin: 4px auto !important;
  }
  h1 {
    white-space: pre-wrap;
    word-wrap: break-word;
    word-break: break-all;
  }
  a {
    cursor: pointer;
    color: #4a680d;
    text-decoration: underline;
  }
</style>
